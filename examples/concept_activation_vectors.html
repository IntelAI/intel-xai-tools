<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Show cases Testing with Concept Activation Vectors (TCAV) on Imagenet Dataset and GoogleNet model &mdash; Explainer</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/togglebutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/mystnb.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sphinx-thebe.css" type="text/css" />
      <link rel="stylesheet" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../_static/togglebutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.9.1/mermaid.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
        <script src="../_static/design-tabs.js"></script>
        <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
        <script async="async" src="../_static/sphinx-thebe.js"></script>
        <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html">
            <img src="../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../usecases/index.html">Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../requirements/index.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design/index.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bibliography/index.html">Bibliography</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Python</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Show cases Testing with Concept Activation Vectors (TCAV) on Imagenet Dataset and GoogleNet model</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/examples/concept_activation_vectors.ipynb" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="show-cases-testing-with-concept-activation-vectors-tcav-on-imagenet-dataset-and-googlenet-model">
<h1>Show cases Testing with Concept Activation Vectors (TCAV) on Imagenet Dataset and GoogleNet model<a class="headerlink" href="#show-cases-testing-with-concept-activation-vectors-tcav-on-imagenet-dataset-and-googlenet-model" title="Permalink to this headline"></a></h1>
<p>This tutorial shows how to apply TCAV, a concept-based model interpretability algorithm, on a classification task using GoogleNet model and imagenet dataset.</p>
<p>More details about the approach can be found here:
<a class="reference external" href="https://arxiv.org/pdf/1711.11279.pdf">https://arxiv.org/pdf/1711.11279.pdf</a></p>
<p>In order to use TCAV, we need to predefine a list of concepts that we want our predictions to be test against.</p>
<p><strong>Concepts</strong> are human-understandable, high-level abstractions such as visually represented “stripes” in case of images or tokens such as “female” in case of text. Concepts are formatted and represented as input tensors and do not need to be part of the training or test datasets.</p>
<p>Concepts are incorporated into the importance score computations using Concept Activation Vectors (CAVs). Traditionally, CAVs train linear classifiers and learn decision boundaries between different concepts using the activations of predefined concepts in a NN layer as inputs to the classifier that we train. The vector that is orthogonal to learnt decision boundary and is pointing towards the direction of a concept is the CAV of that concept.</p>
<p>TCAV measures the importance of a concept for a prediction based on the directional sensitivity (derivatives) of a concept in Neural Network (NN) layers. For a given concept and layer it is obtained by <strong>aggregating</strong> the dot product between CAV for a given concept in a given layer and the gradients of model predictions w.r.t. given layer output. The aggregation can be performed based on either signs or magnitudes of the directional sensitivities of concepts across multiple examples belonging to a certain class. More details about the technique can be found in above mentioned papers.</p>
<p><strong>Note:</strong> Before running this tutorial, please install the torchvision, numpy, scipy, sklearn, PIL, and matplotlib packages.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">glob</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">ttest_ind</span>

<span class="kn">from</span> <span class="nn">explainer.explainers</span> <span class="kn">import</span> <span class="n">concept_activation_vectors</span>
<span class="c1"># ..........torch imports............</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torchvision</span>

<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">IterableDataset</span><span class="p">,</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>

<span class="c1">#.... Captum imports..................</span>
<span class="kn">from</span> <span class="nn">captum.attr</span> <span class="kn">import</span> <span class="n">LayerGradientXActivation</span><span class="p">,</span> <span class="n">LayerIntegratedGradients</span>

<span class="kn">from</span> <span class="nn">captum.concept</span> <span class="kn">import</span> <span class="n">TCAV</span>
<span class="kn">from</span> <span class="nn">captum.concept</span> <span class="kn">import</span> <span class="n">Concept</span>

<span class="kn">from</span> <span class="nn">captum.concept._utils.data_iterator</span> <span class="kn">import</span> <span class="n">dataset_to_dataloader</span><span class="p">,</span> <span class="n">CustomIterableDataset</span>
<span class="kn">from</span> <span class="nn">captum.concept._utils.common</span> <span class="kn">import</span> <span class="n">concepts_to_str</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="nn">Input In [1],</span> in <span class="ni">&lt;cell line: 12&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="kn">from</span> <span class="nn">explainer.explainers</span> <span class="kn">import</span> <span class="n">concept_activation_vectors</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="c1"># ..........torch imports............</span>
<span class="ne">---&gt; </span><span class="mi">12</span> <span class="kn">import</span> <span class="nn">torch</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="kn">import</span> <span class="nn">torchvision</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span> <span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">IterableDataset</span><span class="p">,</span> <span class="n">DataLoader</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;torch&#39;
</pre></div>
</div>
</div>
</div>
<section id="defining-image-related-transformations-and-functions">
<h2>Defining image related transformations and functions<a class="headerlink" href="#defining-image-related-transformations-and-functions" title="Permalink to this headline"></a></h2>
<p>Let’s define image transformation function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Method to normalize an image to Imagenet mean and standard deviation</span>
<span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>

    <span class="k">return</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span>
                <span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span> <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">]</span>
            <span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)(</span><span class="n">img</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s define a few helper functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_tensor_from_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">load_image_tensors</span><span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="n">root_path</span><span class="o">=</span><span class="s1">&#39;data/tcav/image/imagenet/&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/*.jpg&#39;</span><span class="p">)</span>

    <span class="n">tensors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
        <span class="n">tensors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="k">if</span> <span class="n">transform</span> <span class="k">else</span> <span class="n">img</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">tensors</span>
</pre></div>
</div>
</div>
</div>
<p>Defining a helper function to load predefined concepts. <code class="docutils literal notranslate"><span class="pre">assemble_concept</span></code> function reads the concepts using a directory path where the concepts are residing and constructs concept object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">assemble_concept</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">concepts_path</span><span class="o">=</span><span class="s2">&quot;data/tcav/image/concepts/&quot;</span><span class="p">):</span>
    <span class="n">concept_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">concepts_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">CustomIterableDataset</span><span class="p">(</span><span class="n">get_tensor_from_filename</span><span class="p">,</span> <span class="n">concept_path</span><span class="p">)</span>
    <span class="n">concept_iter</span> <span class="o">=</span> <span class="n">dataset_to_dataloader</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Concept</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">data_iter</span><span class="o">=</span><span class="n">concept_iter</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s assemble concepts into Concept instances using Concept class and concept images stored in <code class="docutils literal notranslate"><span class="pre">concepts_path</span></code>. We will use these concepts later in our experiments.
Below we define five concepts. Three out of five are related to image texture and patterns such as <code class="docutils literal notranslate"><span class="pre">striped</span></code>, <code class="docutils literal notranslate"><span class="pre">zigzagged</span></code> and <code class="docutils literal notranslate"><span class="pre">dotted</span></code>. The other two represent random concepts. Random concepts contain elements / images that are associated with various possible concepts. Distinct from those defined for <code class="docutils literal notranslate"><span class="pre">striped</span></code>, <code class="docutils literal notranslate"><span class="pre">zigzagged</span></code> and <code class="docutils literal notranslate"><span class="pre">dotted</span></code>.</p>
<p>Note that concepts should be created and stored under <code class="docutils literal notranslate"><span class="pre">data/tcav/image/concepts/</span></code> folder in advance.</p>
<p><code class="docutils literal notranslate"><span class="pre">striped</span></code>, <code class="docutils literal notranslate"><span class="pre">zigzagged</span></code> and <code class="docutils literal notranslate"><span class="pre">dotted</span></code> concepts can be found in broden dataset:  <a class="reference external" href="https://netdissect.csail.mit.edu/broden1_224">https://netdissect.csail.mit.edu/broden1_224</a>, under <code class="docutils literal notranslate"><span class="pre">images/dtd</span></code> folder as also described here: <a class="reference external" href="https://github.com/tensorflow/tcav/tree/master/tcav/tcav_examples/image_models/imagenet">https://github.com/tensorflow/tcav/tree/master/tcav/tcav_examples/image_models/imagenet</a>. There are in total 120 images for each of the <code class="docutils literal notranslate"><span class="pre">striped</span></code>, <code class="docutils literal notranslate"><span class="pre">zigzagged</span></code> and <code class="docutils literal notranslate"><span class="pre">dotted</span></code> concepts.</p>
<p>Please, download those concept images and place under <code class="docutils literal notranslate"><span class="pre">striped</span></code>, <code class="docutils literal notranslate"><span class="pre">zigzagged</span></code> and <code class="docutils literal notranslate"><span class="pre">dotted</span></code> folders under <code class="docutils literal notranslate"><span class="pre">data/tcav/image/concepts/</span></code> folder accordingly.</p>
<p>Random type of concepts are uniformly sampled from imagenet dataset. More details on how to download and setup imagenet dataset can he found here:
<a class="reference external" href="https://github.com/tensorflow/tcav/tree/master/tcav/tcav_examples/image_models/imagenet">https://github.com/tensorflow/tcav/tree/master/tcav/tcav_examples/image_models/imagenet</a></p>
<p>We will randomly sample 4 diffent sets of 120 random images from imagenet dataset. Note that these images should be distinct from concept and zebra images since the testing will be performed on zebra images.
Place random images under <code class="docutils literal notranslate"><span class="pre">random_0</span></code>, <code class="docutils literal notranslate"><span class="pre">random_1</span></code>, <code class="docutils literal notranslate"><span class="pre">random_2</span></code> and <code class="docutils literal notranslate"><span class="pre">random_3</span></code> folders under <code class="docutils literal notranslate"><span class="pre">data/tcav/image/concepts/</span></code> folder similar to <code class="docutils literal notranslate"><span class="pre">striped</span></code> concept.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">concepts_path</span> <span class="o">=</span> <span class="s2">&quot;data/tcav/image/concepts/&quot;</span>

<span class="n">stripes_concept</span> <span class="o">=</span> <span class="n">assemble_concept</span><span class="p">(</span><span class="s2">&quot;striped&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">concepts_path</span><span class="o">=</span><span class="n">concepts_path</span><span class="p">)</span>
<span class="n">zigzagged_concept</span> <span class="o">=</span> <span class="n">assemble_concept</span><span class="p">(</span><span class="s2">&quot;zigzagged&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">concepts_path</span><span class="o">=</span><span class="n">concepts_path</span><span class="p">)</span>
<span class="n">dotted_concept</span> <span class="o">=</span> <span class="n">assemble_concept</span><span class="p">(</span><span class="s2">&quot;dotted&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">concepts_path</span><span class="o">=</span><span class="n">concepts_path</span><span class="p">)</span>


<span class="n">random_0_concept</span> <span class="o">=</span> <span class="n">assemble_concept</span><span class="p">(</span><span class="s2">&quot;random_0&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">concepts_path</span><span class="o">=</span><span class="n">concepts_path</span><span class="p">)</span>
<span class="n">random_1_concept</span> <span class="o">=</span> <span class="n">assemble_concept</span><span class="p">(</span><span class="s2">&quot;random_1&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">concepts_path</span><span class="o">=</span><span class="n">concepts_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">Input In [5],</span> in <span class="ni">&lt;cell line: 3&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">concepts_path</span> <span class="o">=</span> <span class="s2">&quot;data/tcav/image/concepts/&quot;</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">stripes_concept</span> <span class="o">=</span> <span class="n">assemble_concept</span><span class="p">(</span><span class="s2">&quot;striped&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">concepts_path</span><span class="o">=</span><span class="n">concepts_path</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">zigzagged_concept</span> <span class="o">=</span> <span class="n">assemble_concept</span><span class="p">(</span><span class="s2">&quot;zigzagged&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">concepts_path</span><span class="o">=</span><span class="n">concepts_path</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">dotted_concept</span> <span class="o">=</span> <span class="n">assemble_concept</span><span class="p">(</span><span class="s2">&quot;dotted&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">concepts_path</span><span class="o">=</span><span class="n">concepts_path</span><span class="p">)</span>

<span class="nn">Input In [4],</span> in <span class="ni">assemble_concept</span><span class="nt">(name, id, concepts_path)</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="k">def</span> <span class="nf">assemble_concept</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">concepts_path</span><span class="o">=</span><span class="s2">&quot;data/tcav/image/concepts/&quot;</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="n">concept_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">concepts_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
<span class="ne">----&gt; </span><span class="mi">3</span>     <span class="n">dataset</span> <span class="o">=</span> <span class="n">CustomIterableDataset</span><span class="p">(</span><span class="n">get_tensor_from_filename</span><span class="p">,</span> <span class="n">concept_path</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="n">concept_iter</span> <span class="o">=</span> <span class="n">dataset_to_dataloader</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="k">return</span> <span class="n">Concept</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">data_iter</span><span class="o">=</span><span class="n">concept_iter</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;CustomIterableDataset&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Let’s visualize some samples from those concepts</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_figs</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">n_concepts</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_concepts</span><span class="p">,</span> <span class="n">n_figs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">n_concepts</span><span class="p">))</span>

<span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">concept</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">stripes_concept</span><span class="p">,</span> <span class="n">zigzagged_concept</span><span class="p">,</span> <span class="n">dotted_concept</span><span class="p">,</span> <span class="n">random_0_concept</span><span class="p">,</span> <span class="n">random_1_concept</span><span class="p">]):</span>
    <span class="n">concept_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">concepts_path</span><span class="p">,</span> <span class="n">concept</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
    <span class="n">img_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">concept_path</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">img_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">img_files</span><span class="p">[:</span><span class="n">n_figs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">img_file</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">concept</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;sans-serif&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_file</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">Input In [6],</span> in <span class="ni">&lt;cell line: 6&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">n_concepts</span> <span class="o">=</span> <span class="mi">5</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_concepts</span><span class="p">,</span> <span class="n">n_figs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">n_concepts</span><span class="p">))</span>
<span class="ne">----&gt; </span><span class="mi">6</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">concept</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">stripes_concept</span><span class="p">,</span> <span class="n">zigzagged_concept</span><span class="p">,</span> <span class="n">dotted_concept</span><span class="p">,</span> <span class="n">random_0_concept</span><span class="p">,</span> <span class="n">random_1_concept</span><span class="p">]):</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>     <span class="n">concept_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">concepts_path</span><span class="p">,</span> <span class="n">concept</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>     <span class="n">img_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">concept_path</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;stripes_concept&#39; is not defined
</pre></div>
</div>
<img alt="../_images/bc39db5bd4b03e5ae81363a5e76f8e7bc667247ca9ca0a0635b47f815bad460f.png" src="../_images/bc39db5bd4b03e5ae81363a5e76f8e7bc667247ca9ca0a0635b47f815bad460f.png" />
</div>
</div>
</section>
<section id="defining-googlenet-model">
<h2>Defining GoogleNet Model<a class="headerlink" href="#defining-googlenet-model" title="Permalink to this headline"></a></h2>
<p>For this tutorial, we will load GoogleNet model and set in eval mode.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">googlenet</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">Input In [7],</span> in <span class="ni">&lt;cell line: 1&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">googlenet</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

<span class="ne">NameError</span>: name &#39;torchvision&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="computing-tcav-scores">
<h2>Computing TCAV Scores<a class="headerlink" href="#computing-tcav-scores" title="Permalink to this headline"></a></h2>
<p>Next, let’s create TCAV class by passing the instance of GoogleNet model, a custom classifier and the list of layers where we would like to test the importance of concepts.</p>
<p>The custom classifier will be trained to learn classification boundaries between concepts. We offer a default implementation of Custom Classifier in captum library so that the users do not need to define it. Captum users, hoowever, are welcome to define their own classifers with any custom logic. CustomClassifier class extends abstract Classifier class and provides implementations for training workflow for the classifier and means to access trained weights and classes. Typically, this can be, but is not limited to a classier, from sklearn library. In this case CustomClassifier wraps <code class="docutils literal notranslate"><span class="pre">linear_model.SGDClassifier</span></code> algorithm from sklearn library.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;inception4c&#39;</span><span class="p">,</span> <span class="s1">&#39;inception4d&#39;</span><span class="p">,</span> <span class="s1">&#39;inception4e&#39;</span><span class="p">]</span>

<span class="n">mytcav</span> <span class="o">=</span> <span class="n">TCAV</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
              <span class="n">layers</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span>
              <span class="n">layer_attr_method</span> <span class="o">=</span> <span class="n">LayerIntegratedGradients</span><span class="p">(</span>
                <span class="n">model</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">multiply_by_inputs</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">Input In [8],</span> in <span class="ni">&lt;cell line: 3&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;inception4c&#39;</span><span class="p">,</span> <span class="s1">&#39;inception4d&#39;</span><span class="p">,</span> <span class="s1">&#39;inception4e&#39;</span><span class="p">]</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">mytcav</span> <span class="o">=</span> <span class="n">TCAV</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>               <span class="n">layers</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>               <span class="n">layer_attr_method</span> <span class="o">=</span> <span class="n">LayerIntegratedGradients</span><span class="p">(</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>                 <span class="n">model</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">multiply_by_inputs</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="ne">NameError</span>: name &#39;TCAV&#39; is not defined
</pre></div>
</div>
</div>
</div>
<section id="defining-experimantal-sets-for-cav">
<h3>Defining experimantal sets for CAV<a class="headerlink" href="#defining-experimantal-sets-for-cav" title="Permalink to this headline"></a></h3>
<p>Then, lets create 2 experimental sets: [“striped”, “random_0”] and [“striped”, “random_1”].</p>
<p>We will train a classifier for each experimal set that learns hyperplanes which separate the concepts in each experimental set from one another. This is especially interesting when later we want to perform two-sided statistical significance testing in order to confirm or reject the significance of a concept in a specific layer for predictions.</p>
<p>Now, let’s load sample images from imagenet. The goal is to test how sensitive model predictions are to predefined concepts such as ‘striped’ when predicting ‘zebra’ class.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">experimental_set_rand</span> <span class="o">=</span> <span class="p">[[</span><span class="n">stripes_concept</span><span class="p">,</span> <span class="n">random_0_concept</span><span class="p">],</span> <span class="p">[</span><span class="n">stripes_concept</span><span class="p">,</span> <span class="n">random_1_concept</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">Input In [9],</span> in <span class="ni">&lt;cell line: 1&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">experimental_set_rand</span> <span class="o">=</span> <span class="p">[[</span><span class="n">stripes_concept</span><span class="p">,</span> <span class="n">random_0_concept</span><span class="p">],</span> <span class="p">[</span><span class="n">stripes_concept</span><span class="p">,</span> <span class="n">random_1_concept</span><span class="p">]]</span>

<span class="ne">NameError</span>: name &#39;stripes_concept&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Now, let’s load sample images from imagenet. The goal is to test how sensitive model predictions are to predefined concepts such as ‘striped’ when predicting ‘zebra’ class.</p>
<p>Please, download zebra images and place them under <code class="docutils literal notranslate"><span class="pre">data/tcav/image/imagenet/zebra</span></code> folder in advance before running the cell below. For our experiments we used 50 different zebra images from imagenet dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load sample images from folder</span>
<span class="n">zebra_imgs</span> <span class="o">=</span> <span class="n">load_image_tensors</span><span class="p">(</span><span class="s1">&#39;zebra&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Visualizing some of the images that we will use for making predictions and explaining those predictions by the means of concepts defined above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">zebra_imgs</span><span class="p">[</span><span class="mi">40</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">zebra_imgs</span><span class="p">[</span><span class="mi">41</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">zebra_imgs</span><span class="p">[</span><span class="mi">34</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">zebra_imgs</span><span class="p">[</span><span class="mi">31</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">zebra_imgs</span><span class="p">[</span><span class="mi">30</span><span class="p">])</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">IndexError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="nn">Input In [11],</span> in <span class="ni">&lt;cell line: 2&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">zebra_imgs</span><span class="p">[</span><span class="mi">40</span><span class="p">])</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">zebra_imgs</span><span class="p">[</span><span class="mi">41</span><span class="p">])</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">zebra_imgs</span><span class="p">[</span><span class="mi">34</span><span class="p">])</span>

<span class="ne">IndexError</span>: list index out of range
</pre></div>
</div>
<img alt="../_images/4d976ab5cc16075afbee1d9cb922be806a53e21fc7a74ecb41b107d73d0c076c.png" src="../_images/4d976ab5cc16075afbee1d9cb922be806a53e21fc7a74ecb41b107d73d0c076c.png" />
</div>
</div>
<p>Here we perform a transformation and convert the images into tensors, so that we can use them as inputs to NN model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load sample images from folder</span>
<span class="n">zebra_tensors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">zebra_imgs</span><span class="p">])</span>
<span class="n">experimental_set_rand</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">Input In [12],</span> in <span class="ni">&lt;cell line: 2&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># Load sample images from folder</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">zebra_tensors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">zebra_imgs</span><span class="p">])</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">experimental_set_rand</span>

<span class="ne">NameError</span>: name &#39;torch&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># zebra class index</span>
<span class="n">zebra_ind</span> <span class="o">=</span> <span class="mi">340</span>


<span class="n">tcav_scores_w_random</span> <span class="o">=</span> <span class="n">mytcav</span><span class="o">.</span><span class="n">interpret</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">zebra_tensors</span><span class="p">,</span>
                                        <span class="n">experimental_sets</span><span class="o">=</span><span class="n">experimental_set_rand</span><span class="p">,</span>
                                        <span class="n">target</span><span class="o">=</span><span class="n">zebra_ind</span><span class="p">,</span>
                                        <span class="n">n_steps</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                       <span class="p">)</span>
<span class="n">tcav_scores_w_random</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">Input In [13],</span> in <span class="ni">&lt;cell line: 5&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># zebra class index</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">zebra_ind</span> <span class="o">=</span> <span class="mi">340</span>
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="n">tcav_scores_w_random</span> <span class="o">=</span> <span class="n">mytcav</span><span class="o">.</span><span class="n">interpret</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">zebra_tensors</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>                                         <span class="n">experimental_sets</span><span class="o">=</span><span class="n">experimental_set_rand</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>                                         <span class="n">target</span><span class="o">=</span><span class="n">zebra_ind</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>                                         <span class="n">n_steps</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span>                                        <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="n">tcav_scores_w_random</span>

<span class="ne">NameError</span>: name &#39;mytcav&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Auxiliary functions for visualizing of TCAV scores.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">format_float</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">0.0005</span> <span class="k">else</span> <span class="s1">&#39;</span><span class="si">{:.3e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">plot_tcav_scores</span><span class="p">(</span><span class="n">experimental_sets</span><span class="p">,</span> <span class="n">tcav_scores</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">experimental_sets</span><span class="p">),</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

    <span class="n">barWidth</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">experimental_sets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx_es</span><span class="p">,</span> <span class="n">concepts</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">experimental_sets</span><span class="p">):</span>

        <span class="n">concepts</span> <span class="o">=</span> <span class="n">experimental_sets</span><span class="p">[</span><span class="n">idx_es</span><span class="p">]</span>
        <span class="n">concepts_key</span> <span class="o">=</span> <span class="n">concepts_to_str</span><span class="p">(</span><span class="n">concepts</span><span class="p">)</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">concepts</span><span class="p">)):</span>
            <span class="n">pos</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">x</span> <span class="o">+</span> <span class="n">barWidth</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">_ax</span> <span class="o">=</span> <span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">idx_es</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">experimental_sets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">ax</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">concepts</span><span class="p">)):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">format_float</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="s1">&#39;sign_count&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">layer</span><span class="p">,</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">tcav_scores</span><span class="p">[</span><span class="n">concepts_key</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
            <span class="n">_ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">val</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">barWidth</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">concepts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Add xticks on the middle of the group bars</span>
        <span class="n">_ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Set </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx_es</span><span class="p">)),</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">_ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="n">r</span> <span class="o">+</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">barWidth</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">))])</span>
        <span class="n">_ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

        <span class="c1"># Create legend &amp; Show graphic</span>
        <span class="n">_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s use above defined auxilary functions and visualize tcav scores below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_tcav_scores</span><span class="p">(</span><span class="n">experimental_set_rand</span><span class="p">,</span> <span class="n">tcav_scores_w_random</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">Input In [15],</span> in <span class="ni">&lt;cell line: 1&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">plot_tcav_scores</span><span class="p">(</span><span class="n">experimental_set_rand</span><span class="p">,</span> <span class="n">tcav_scores_w_random</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;experimental_set_rand&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>From the plot above we observe that the images that are predicted as <code class="docutils literal notranslate"><span class="pre">zebra</span></code> by the model are very sensitive  to <code class="docutils literal notranslate"><span class="pre">striped</span></code> concept as opposed to any random concept. Note that random concepts contain a set of images that are uniformly sampled from imagenet dataset - they do not represent any specific concept.</p>
<p>Now, let’s compute TCAV scores for a different experimental set that contains three different specific concepts such as <code class="docutils literal notranslate"><span class="pre">striped</span></code>, <code class="docutils literal notranslate"><span class="pre">zigzagged</span></code> and <code class="docutils literal notranslate"><span class="pre">dotted</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">experimental_set_zig_dot</span> <span class="o">=</span> <span class="p">[[</span><span class="n">stripes_concept</span><span class="p">,</span> <span class="n">zigzagged_concept</span><span class="p">,</span> <span class="n">dotted_concept</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">Input In [16],</span> in <span class="ni">&lt;cell line: 1&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">experimental_set_zig_dot</span> <span class="o">=</span> <span class="p">[[</span><span class="n">stripes_concept</span><span class="p">,</span> <span class="n">zigzagged_concept</span><span class="p">,</span> <span class="n">dotted_concept</span><span class="p">]]</span>

<span class="ne">NameError</span>: name &#39;stripes_concept&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tcav_scores_w_zig_dot</span> <span class="o">=</span> <span class="n">mytcav</span><span class="o">.</span><span class="n">interpret</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">zebra_tensors</span><span class="p">,</span>
                                         <span class="n">experimental_sets</span><span class="o">=</span><span class="n">experimental_set_zig_dot</span><span class="p">,</span>
                                         <span class="n">target</span><span class="o">=</span><span class="n">zebra_ind</span><span class="p">,</span>
                                         <span class="n">n_steps</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">Input In [17],</span> in <span class="ni">&lt;cell line: 1&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">tcav_scores_w_zig_dot</span> <span class="o">=</span> <span class="n">mytcav</span><span class="o">.</span><span class="n">interpret</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">zebra_tensors</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>                                          <span class="n">experimental_sets</span><span class="o">=</span><span class="n">experimental_set_zig_dot</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                                          <span class="n">target</span><span class="o">=</span><span class="n">zebra_ind</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                                          <span class="n">n_steps</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;mytcav&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_tcav_scores</span><span class="p">(</span><span class="n">experimental_set_zig_dot</span><span class="p">,</span> <span class="n">tcav_scores_w_zig_dot</span><span class="p">)</span>    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">Input In [18],</span> in <span class="ni">&lt;cell line: 1&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">plot_tcav_scores</span><span class="p">(</span><span class="n">experimental_set_zig_dot</span><span class="p">,</span> <span class="n">tcav_scores_w_zig_dot</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;experimental_set_zig_dot&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Similar to the previous case in this experiment as well we observe that <code class="docutils literal notranslate"><span class="pre">striped</span></code> concept has very high TCAV scores across all  three layers compared to <code class="docutils literal notranslate"><span class="pre">zigzagged</span></code> and <code class="docutils literal notranslate"><span class="pre">dotted</span></code>. This means that the <code class="docutils literal notranslate"><span class="pre">striped</span></code> concept is an essential concept in predicting <code class="docutils literal notranslate"><span class="pre">zebra</span></code>.</p>
</section>
</section>
</section>
<section id="statistical-significance-testing-of-concepts">
<h1>Statistical significance testing of concepts<a class="headerlink" href="#statistical-significance-testing-of-concepts" title="Permalink to this headline"></a></h1>
<p>In order to convince ourselves that our concepts truly explain our predictions, we conduct statistical significance tests on TCAV scores by constructing a number of experimental sets. In this case we look into the <code class="docutils literal notranslate"><span class="pre">striped</span></code> concept and a number of random concepts.
If <code class="docutils literal notranslate"><span class="pre">striped</span></code> concept is truly important in predicting <code class="docutils literal notranslate"><span class="pre">zebra</span></code> in the images that contain <code class="docutils literal notranslate"><span class="pre">zebra</span></code>, then we will see consistent high TCAV scores for <code class="docutils literal notranslate"><span class="pre">striped</span></code> concept across all experimental sets as apposed to any other concept.</p>
<p>Each experimental set contains a random concept consisting of a number of random subsamples. In our case this allows us to estimate the robustness of TCAV scores by the means of numerous random concepts.</p>
<p>Let’s define those experimental sets in the cell below.</p>
<p>We will look into <code class="docutils literal notranslate"><span class="pre">striped</span></code>, and a number of random concepts drawn uniformly random from imagenet dataset.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">concept_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;stripped&#39;</span><span class="p">,</span> <span class="s1">&#39;ceo&#39;</span><span class="p">,</span> <span class="s1">&#39;random_0&#39;</span><span class="p">,</span> <span class="s1">&#39;random_1&#39;</span><span class="p">,</span> <span class="s1">&#39;random2&#39;</span><span class="p">,</span> <span class="o">...</span> <span class="p">,</span> <span class="s1">&#39;random_n&#39;</span><span class="p">],</span> <span class="n">n</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">concepts</span>
</pre></div>
</div>
<p>Then, we will construct pairs of experimental sets that contain pairs of two concepts. In this case:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">experimental_sets</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;stripped&#39;</span><span class="p">,</span> <span class="s1">&#39;random_0&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;stripped&#39;</span><span class="p">,</span> <span class="s1">&#39;random_1&#39;</span><span class="p">],</span> <span class="o">...</span> <span class="p">,</span> <span class="p">[</span><span class="s1">&#39;striped&#39;</span><span class="p">,</span> <span class="s1">&#39;random_n&#39;</span><span class="p">],</span> 
                    <span class="p">[</span><span class="s1">&#39;random_0&#39;</span><span class="p">,</span> <span class="s1">&#39;random_1&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;random_0&#39;</span><span class="p">,</span> <span class="s1">&#39;random_2&#39;</span><span class="p">],</span> <span class="o">...</span> <span class="p">,</span> <span class="p">[</span><span class="s1">&#39;random_0&#39;</span><span class="p">,</span> <span class="s1">&#39;random_n&#39;</span><span class="p">]]</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">random_concepts</span> <span class="o">=</span> <span class="p">[</span><span class="n">assemble_concept</span><span class="p">(</span><span class="s1">&#39;random_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">random_concepts</span><span class="p">)</span>

<span class="n">experimental_sets</span> <span class="o">=</span> <span class="p">[[</span><span class="n">stripes_concept</span><span class="p">,</span> <span class="n">random_0_concept</span><span class="p">],</span> <span class="p">[</span><span class="n">stripes_concept</span><span class="p">,</span> <span class="n">random_1_concept</span><span class="p">]]</span>
<span class="n">experimental_sets</span><span class="o">.</span><span class="n">extend</span><span class="p">([[</span><span class="n">stripes_concept</span><span class="p">,</span> <span class="n">random_concept</span><span class="p">]</span> <span class="k">for</span> <span class="n">random_concept</span> <span class="ow">in</span> <span class="n">random_concepts</span><span class="p">])</span>

<span class="n">experimental_sets</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">random_0_concept</span><span class="p">,</span> <span class="n">random_1_concept</span><span class="p">])</span>
<span class="n">experimental_sets</span><span class="o">.</span><span class="n">extend</span><span class="p">([[</span><span class="n">random_0_concept</span><span class="p">,</span> <span class="n">random_concept</span><span class="p">]</span> <span class="k">for</span> <span class="n">random_concept</span> <span class="ow">in</span> <span class="n">random_concepts</span><span class="p">])</span>

<span class="n">experimental_sets</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">Input In [19],</span> in <span class="ni">&lt;cell line: 3&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">2</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">random_concepts</span> <span class="o">=</span> <span class="p">[</span><span class="n">assemble_concept</span><span class="p">(</span><span class="s1">&#39;random_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)]</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="nb">print</span><span class="p">(</span><span class="n">random_concepts</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="n">experimental_sets</span> <span class="o">=</span> <span class="p">[[</span><span class="n">stripes_concept</span><span class="p">,</span> <span class="n">random_0_concept</span><span class="p">],</span> <span class="p">[</span><span class="n">stripes_concept</span><span class="p">,</span> <span class="n">random_1_concept</span><span class="p">]]</span>

<span class="nn">Input In [19],</span> in <span class="ni">&lt;listcomp&gt;</span><span class="nt">(.0)</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">2</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">random_concepts</span> <span class="o">=</span> <span class="p">[</span><span class="n">assemble_concept</span><span class="p">(</span><span class="s1">&#39;random_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)]</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="nb">print</span><span class="p">(</span><span class="n">random_concepts</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="n">experimental_sets</span> <span class="o">=</span> <span class="p">[[</span><span class="n">stripes_concept</span><span class="p">,</span> <span class="n">random_0_concept</span><span class="p">],</span> <span class="p">[</span><span class="n">stripes_concept</span><span class="p">,</span> <span class="n">random_1_concept</span><span class="p">]]</span>

<span class="nn">Input In [4],</span> in <span class="ni">assemble_concept</span><span class="nt">(name, id, concepts_path)</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="k">def</span> <span class="nf">assemble_concept</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">concepts_path</span><span class="o">=</span><span class="s2">&quot;data/tcav/image/concepts/&quot;</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="n">concept_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">concepts_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
<span class="ne">----&gt; </span><span class="mi">3</span>     <span class="n">dataset</span> <span class="o">=</span> <span class="n">CustomIterableDataset</span><span class="p">(</span><span class="n">get_tensor_from_filename</span><span class="p">,</span> <span class="n">concept_path</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="n">concept_iter</span> <span class="o">=</span> <span class="n">dataset_to_dataloader</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="k">return</span> <span class="n">Concept</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">data_iter</span><span class="o">=</span><span class="n">concept_iter</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;CustomIterableDataset&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Now, let’s define a convenience function for assembling the experiments together as lists of Concept objects, creating and running the TCAV:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">assemble_scores</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">experimental_sets</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">score_layer</span><span class="p">,</span> <span class="n">score_type</span><span class="p">):</span>
    <span class="n">score_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">concepts</span> <span class="ow">in</span> <span class="n">experimental_sets</span><span class="p">:</span>
        <span class="n">score_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">concepts</span><span class="p">])][</span><span class="n">score_layer</span><span class="p">][</span><span class="n">score_type</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>
        
    <span class="k">return</span> <span class="n">score_list</span>
</pre></div>
</div>
</div>
</div>
<p>In addition, it is interesting to look into the p-values of statistical significance tests for each concept. We say, that we reject null hypothesis, if the p-value for concept’s TCAV scores is smaller than 0.05. This indicates that the concept is important for model prediction.</p>
<p>We label concept populations as overlapping if p-value &gt; 0.05 otherwise disjoint.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_pval</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">experimental_sets</span><span class="p">,</span> <span class="n">score_layer</span><span class="p">,</span> <span class="n">score_type</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">print_ret</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    
    <span class="n">P1</span> <span class="o">=</span> <span class="n">assemble_scores</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">experimental_sets</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">score_layer</span><span class="p">,</span> <span class="n">score_type</span><span class="p">)</span>
    <span class="n">P2</span> <span class="o">=</span> <span class="n">assemble_scores</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">experimental_sets</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">score_layer</span><span class="p">,</span> <span class="n">score_type</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">print_ret</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;P1[mean, std]: &#39;</span><span class="p">,</span> <span class="n">format_float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">P1</span><span class="p">)),</span> <span class="n">format_float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">P1</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;P2[mean, std]: &#39;</span><span class="p">,</span> <span class="n">format_float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">P2</span><span class="p">)),</span> <span class="n">format_float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">P2</span><span class="p">)))</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">pval</span> <span class="o">=</span> <span class="n">ttest_ind</span><span class="p">(</span><span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">print_ret</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;p-values:&quot;</span><span class="p">,</span> <span class="n">format_float</span><span class="p">(</span><span class="n">pval</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">pval</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">:</span>    <span class="c1"># alpha value is 0.05 or 5%</span>
        <span class="n">relation</span> <span class="o">=</span> <span class="s2">&quot;Disjoint&quot;</span>
        <span class="k">if</span> <span class="n">print_ret</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Disjoint&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">relation</span> <span class="o">=</span> <span class="s2">&quot;Overlap&quot;</span>
        <span class="k">if</span> <span class="n">print_ret</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Overlap&quot;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">format_float</span><span class="p">(</span><span class="n">pval</span><span class="p">),</span> <span class="n">relation</span>
</pre></div>
</div>
</div>
</div>
<p>We now run the TCAV and obtain the scores:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run TCAV</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">mytcav</span><span class="o">.</span><span class="n">interpret</span><span class="p">(</span><span class="n">zebra_tensors</span><span class="p">,</span> <span class="n">experimental_sets</span><span class="p">,</span> <span class="n">zebra_ind</span><span class="p">,</span> <span class="n">n_steps</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">Input In [22],</span> in <span class="ni">&lt;cell line: 2&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># Run TCAV</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">scores</span> <span class="o">=</span> <span class="n">mytcav</span><span class="o">.</span><span class="n">interpret</span><span class="p">(</span><span class="n">zebra_tensors</span><span class="p">,</span> <span class="n">experimental_sets</span><span class="p">,</span> <span class="n">zebra_ind</span><span class="p">,</span> <span class="n">n_steps</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;mytcav&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We can present the distribution of tcav scores using boxplots and the p-values indicating whether TCAV scores of those concepts are overlapping or disjoint.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">4</span>
<span class="k">def</span> <span class="nf">show_boxplots</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;sign_count&#39;</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">format_label_text</span><span class="p">(</span><span class="n">experimental_sets</span><span class="p">):</span>
        <span class="n">concept_id_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> \
                             <span class="n">exp</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">exp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">experimental_sets</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="k">return</span> <span class="n">concept_id_list</span>

    <span class="n">n_plots</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_plots</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="mi">18</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_plots</span><span class="p">):</span>
        <span class="n">esl</span> <span class="o">=</span> <span class="n">experimental_sets</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span><span class="p">]</span>
        <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">pval</span><span class="p">,</span> <span class="n">relation</span> <span class="o">=</span> <span class="n">get_pval</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">esl</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">layer</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">metric</span> <span class="o">+</span> <span class="s2">&quot; (pval=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pval</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="n">relation</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">boxplot</span><span class="p">([</span><span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">],</span> <span class="n">showfliers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">format_label_text</span><span class="p">(</span><span class="n">esl</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Below box plots visualize the distribution of TCAV scores for two pairs of concepts in three different layers. Each layer is visualized in a separate jupyter cell.
Below diagrams show that <code class="docutils literal notranslate"><span class="pre">striped</span></code> concept has TCAV scores that are consistently high across all layers and experimental sets as apposed to <code class="docutils literal notranslate"><span class="pre">random</span></code> concept. It also shows that <code class="docutils literal notranslate"><span class="pre">striped</span></code> and <code class="docutils literal notranslate"><span class="pre">random</span></code> are disjoint populations.</p>
<p>When we compare the populations of two random concepts we see that the p-value is much higher, meaning that those populations overlap and we cannot reject null hypothesis anymore.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_boxplots</span> <span class="p">(</span><span class="s2">&quot;inception4c&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">Input In [24],</span> in <span class="ni">&lt;cell line: 1&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">show_boxplots</span> <span class="p">(</span><span class="s2">&quot;inception4c&quot;</span><span class="p">)</span>

<span class="nn">Input In [23],</span> in <span class="ni">show_boxplots</span><span class="nt">(layer, metric)</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> <span class="n">fs</span> <span class="o">=</span> <span class="mi">18</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_plots</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">14</span>     <span class="n">esl</span> <span class="o">=</span> <span class="n">experimental_sets</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span><span class="p">]</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span>     <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">pval</span><span class="p">,</span> <span class="n">relation</span> <span class="o">=</span> <span class="n">get_pval</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">esl</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span>     <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="ne">NameError</span>: name &#39;experimental_sets&#39; is not defined
</pre></div>
</div>
<img alt="../_images/355da72ac932650dc36aa37556883b7fe8dab6fdb8b778160a1d4588fd93b991.png" src="../_images/355da72ac932650dc36aa37556883b7fe8dab6fdb8b778160a1d4588fd93b991.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_boxplots</span> <span class="p">(</span><span class="s2">&quot;inception4d&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">Input In [25],</span> in <span class="ni">&lt;cell line: 1&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">show_boxplots</span> <span class="p">(</span><span class="s2">&quot;inception4d&quot;</span><span class="p">)</span>

<span class="nn">Input In [23],</span> in <span class="ni">show_boxplots</span><span class="nt">(layer, metric)</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> <span class="n">fs</span> <span class="o">=</span> <span class="mi">18</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_plots</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">14</span>     <span class="n">esl</span> <span class="o">=</span> <span class="n">experimental_sets</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span><span class="p">]</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span>     <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">pval</span><span class="p">,</span> <span class="n">relation</span> <span class="o">=</span> <span class="n">get_pval</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">esl</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span>     <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="ne">NameError</span>: name &#39;experimental_sets&#39; is not defined
</pre></div>
</div>
<img alt="../_images/355da72ac932650dc36aa37556883b7fe8dab6fdb8b778160a1d4588fd93b991.png" src="../_images/355da72ac932650dc36aa37556883b7fe8dab6fdb8b778160a1d4588fd93b991.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_boxplots</span> <span class="p">(</span><span class="s2">&quot;inception4e&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">Input In [26],</span> in <span class="ni">&lt;cell line: 1&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">show_boxplots</span> <span class="p">(</span><span class="s2">&quot;inception4e&quot;</span><span class="p">)</span>

<span class="nn">Input In [23],</span> in <span class="ni">show_boxplots</span><span class="nt">(layer, metric)</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> <span class="n">fs</span> <span class="o">=</span> <span class="mi">18</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_plots</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">14</span>     <span class="n">esl</span> <span class="o">=</span> <span class="n">experimental_sets</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span><span class="p">]</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span>     <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">pval</span><span class="p">,</span> <span class="n">relation</span> <span class="o">=</span> <span class="n">get_pval</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">esl</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span>     <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="ne">NameError</span>: name &#39;experimental_sets&#39; is not defined
</pre></div>
</div>
<img alt="../_images/355da72ac932650dc36aa37556883b7fe8dab6fdb8b778160a1d4588fd93b991.png" src="../_images/355da72ac932650dc36aa37556883b7fe8dab6fdb8b778160a1d4588fd93b991.png" />
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./examples"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>